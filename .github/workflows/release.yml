# ════════════════════════════════════════════════════════════════════════
# DeFi CLI — Release Workflow
# ════════════════════════════════════════════════════════════════════════
# Triggered by pushing a version tag (e.g. v1.2.0).
# Validates CHANGELOG entry, runs full test suite, and creates a
# GitHub Release with auto-generated notes.
#
# Usage:
#   1. Update version in pyproject.toml (single source of truth)
#   2. Add CHANGELOG.md entry for the new version
#   3. Commit: git commit -m "release: v1.2.0"
#   4. Tag:    git tag v1.2.0
#   5. Push:   git push && git push --tags
#
# T30 Compliance:
#   ✅ All actions pinned by SHA (not tag)
#   ✅ Explicit permissions block (least privilege)
#   ✅ Concurrency control
# ════════════════════════════════════════════════════════════════════════

name: Release

on:
  push:
    tags: ["v*"]

permissions:
  contents: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # ═══════════════════════════════════════════════════════════════════
  # JOB 1: Validate release
  # ═══════════════════════════════════════════════════════════════════
  validate:
    name: Validate Release
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Python 3.12
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: "3.12"

      - name: Extract tag version
        id: tag
        run: echo "version=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"

      - name: Verify pyproject.toml version matches tag
        run: |
          TOML_VERSION=$(python -c "
          import re
          text = open('pyproject.toml').read()
          m = re.search(r'version\s*=\s*\"([^\"]+)\"', text)
          print(m.group(1) if m else 'NOT_FOUND')
          ")
          TAG_VERSION="${{ steps.tag.outputs.version }}"
          echo "pyproject.toml: $TOML_VERSION"
          echo "Git tag:        $TAG_VERSION"
          if [ "$TOML_VERSION" != "$TAG_VERSION" ]; then
            echo "❌ Version mismatch! pyproject.toml=$TOML_VERSION, tag=$TAG_VERSION"
            exit 1
          fi
          echo "✅ Version match: $TAG_VERSION"

      - name: Verify CHANGELOG entry exists
        run: |
          TAG_VERSION="${{ steps.tag.outputs.version }}"
          if grep -q "\[$TAG_VERSION\]" CHANGELOG.md; then
            echo "✅ CHANGELOG entry found for $TAG_VERSION"
          else
            echo "❌ No CHANGELOG entry for [$TAG_VERSION]"
            exit 1
          fi

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest ruff

      - name: Ruff lint + format
        run: ruff check . && ruff format --check .

      - name: Run full test suite
        run: pytest tests/ -v --tb=short -k "not network"

  # ═══════════════════════════════════════════════════════════════════
  # JOB 2: Create GitHub Release
  # ═══════════════════════════════════════════════════════════════════
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: validate
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: Extract tag version
        id: tag
        run: echo "version=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"

      - name: Extract CHANGELOG section
        id: changelog
        run: |
          VERSION="${{ steps.tag.outputs.version }}"
          # Extract section between this version and the next version header
          NOTES=$(awk "/^## \[$VERSION\]/{found=1; next} /^## \[/{if(found) exit} found{print}" CHANGELOG.md)
          # Write to output (multiline)
          {
            echo "notes<<EOF"
            echo "$NOTES"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const { data } = await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: context.ref.replace('refs/tags/', ''),
              name: `DeFi CLI v${{ steps.tag.outputs.version }}`,
              body: `${{ steps.changelog.outputs.notes }}`.trim() || 'See CHANGELOG.md for details.',
              draft: false,
              prerelease: false,
              generate_release_notes: true,
            });
            console.log(`✅ Release created: ${data.html_url}`);
