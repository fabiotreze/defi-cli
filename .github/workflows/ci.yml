# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# DeFi CLI â€” Continuous Integration Pipeline
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Runs on every push to main and every PR targeting main.
# Executes lint, security scans, and the full offline test suite
# across Python 3.10 / 3.11 / 3.12.
#
# T30 Compliance:
#   âœ… All actions pinned by SHA (not tag)
#   âœ… Explicit permissions block (least privilege)
#   âœ… Concurrency control (cancel in-flight for same branch)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# â”€â”€ T30: Least-privilege permissions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
permissions:
  contents: read

# â”€â”€ T30: Concurrency control (cancel stale runs) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 1: Lint & Security Scan
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  lint:
    name: Lint & Security
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Python 3.12
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: "3.12"

      - name: Cache pip packages
        uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684 # v4.2.3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-lint-${{ hashFiles('requirements.txt') }}
          restore-keys: ${{ runner.os }}-pip-lint-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff

      - name: Ruff lint check
        run: ruff check . --output-format=github

      - name: Ruff format check
        run: ruff format --check .

      - name: Security scan â€” sensitive patterns
        run: |
          echo "ðŸ” Scanning for hardcoded secrets..."
          FOUND=0
          # T09: Sensitive patterns (private keys, passwords, API keys, AWS keys)
          if grep -rEn '(?i)private.?key\s*=\s*['"'"'"]0x' --include="*.py" .; then FOUND=1; fi
          if grep -rEn '(?i)password\s*=\s*['"'"'"][^'"'"'"]+['"'"'"]' --include="*.py" . | grep -v example | grep -v test; then FOUND=1; fi
          if grep -rEn 'AKIA[0-9A-Z]{16}' --include="*.py" .; then FOUND=1; fi
          if grep -rEn '(?i)bearer\s+[a-zA-Z0-9._-]{20,}' --include="*.py" .; then FOUND=1; fi
          if [ "$FOUND" -eq 1 ]; then
            echo "âŒ Potential secrets found in source code!"
            exit 1
          fi
          echo "âœ… No secrets detected"

      - name: Security scan â€” dangerous functions
        run: |
          echo "ðŸ” Scanning for eval/exec/pickle..."
          FOUND=0
          if grep -rEn '\beval\s*\(' --include="*.py" . | grep -v '^\./tests/' | grep -v '^#'; then FOUND=1; fi
          if grep -rEn '\bexec\s*\(' --include="*.py" . | grep -v '^\./tests/' | grep -v '^#'; then FOUND=1; fi
          if grep -rEn 'import pickle|import marshal' --include="*.py" .; then FOUND=1; fi
          if [ "$FOUND" -eq 1 ]; then
            echo "âŒ Dangerous function usage detected!"
            exit 1
          fi
          echo "âœ… No dangerous functions found"

      - name: Security scan â€” HTTPS only
        run: |
          echo "ðŸ” Verifying all URLs use HTTPS..."
          if grep -rEn 'http://' --include="*.py" . | grep -v localhost | grep -v '127\.0\.0\.1' | grep -v '^\s*#' | grep -v '"""'; then
            echo "âŒ Non-HTTPS URLs found!"
            exit 1
          fi
          echo "âœ… All external URLs use HTTPS"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 2: Test Matrix (3.10, 3.11, 3.12)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  test:
    name: Test (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    needs: lint
    permissions:
      contents: read

    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.11", "3.12"]

    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: ${{ matrix.python-version }}

      - name: Cache pip packages
        uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684 # v4.2.3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ matrix.python-version }}-${{ hashFiles('requirements.txt') }}
          restore-keys: ${{ runner.os }}-pip-${{ matrix.python-version }}-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest

      - name: Math engine tests (83 tests)
        run: pytest tests/test_math.py -v --tb=short

      - name: Unit tests (195 tests)
        run: pytest tests/test_units.py -v --tb=short

      - name: Code review tests â€” offline (T06â€“T30)
        run: pytest tests/test_codereview.py -v --tb=short -k "not network"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 3: Codereview Report (artifact)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  codereview:
    name: Code Review Report
    runs-on: ubuntu-latest
    needs: test
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Python 3.12
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest

      - name: Run full codereview suite
        run: |
          python tests/test_codereview.py --quick 2>&1 | tee codereview-report.txt
          echo "---"
          echo "Exit code: $?"

      - name: Upload codereview report
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: codereview-report
          path: codereview-report.txt
          retention-days: 30
