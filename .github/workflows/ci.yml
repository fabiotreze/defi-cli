# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# DeFi CLI â€” Continuous Integration Pipeline
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Runs on every push to main and every PR targeting main.
# Executes lint, SAST, dependency audit, security/privacy gate, and
# the full offline test suite across Python 3.10 / 3.11 / 3.12.
#
# Security & Privacy controls (T31-T40) are ENFORCED here â€” any
# regression in CSP, EIP-55, error sanitization, rate limiting,
# temp-file security, masking, tick bounds, XSS, or OWASP compliance
# will FAIL the pipeline and BLOCK the merge.
#
# T30 Compliance:
#   âœ… All actions pinned by SHA (not tag)
#   âœ… Explicit permissions block (least privilege)
#   âœ… Concurrency control (cancel in-flight for same branch)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# â”€â”€ T30: Least-privilege permissions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
permissions:
  contents: read

# â”€â”€ T30: Concurrency control (cancel stale runs) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 1: Lint & Static Security Scan
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  lint:
    name: Lint & Static Security
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Python 3.12
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: "3.12"

      - name: Cache pip packages
        uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684 # v4.2.3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-lint-${{ hashFiles('requirements.txt') }}
          restore-keys: ${{ runner.os }}-pip-lint-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff bandit pip-audit

      - name: Ruff lint check
        run: ruff check . --output-format=github

      - name: Ruff format check
        run: ruff format --check .

      - name: Bandit SAST scan (OWASP A06)
        run: |
          echo "ðŸ” Running Bandit static analysis..."
          bandit -r . -x ./tests,./docs,./.github -f txt -ll
          echo "âœ… Bandit SAST passed"

      - name: Dependency vulnerability audit (OWASP A06)
        run: |
          echo "ðŸ” Auditing dependencies for known CVEs..."
          pip install -r requirements.txt
          pip-audit -r requirements.txt --strict
          echo "âœ… No known vulnerabilities in dependencies"

      - name: Security scan â€” sensitive patterns
        run: |
          echo "ðŸ” Scanning for hardcoded secrets..."
          FOUND=0
          # T09: Sensitive patterns (private keys, passwords, API keys, AWS keys)
          if grep -rEn '(?i)private.?key\s*=\s*['"'"'"]0x' --include="*.py" .; then FOUND=1; fi
          if grep -rEn '(?i)password\s*=\s*['"'"'"][^'"'"'"]+['"'"'"]' --include="*.py" . | grep -v example | grep -v test; then FOUND=1; fi
          if grep -rEn 'AKIA[0-9A-Z]{16}' --include="*.py" .; then FOUND=1; fi
          if grep -rEn '(?i)bearer\s+[a-zA-Z0-9._-]{20,}' --include="*.py" .; then FOUND=1; fi
          if [ "$FOUND" -eq 1 ]; then
            echo "âŒ Potential secrets found in source code!"
            exit 1
          fi
          echo "âœ… No secrets detected"

      - name: Security scan â€” dangerous functions
        run: |
          echo "ðŸ” Scanning for eval/exec/pickle..."
          FOUND=0
          if grep -rEn '\beval\s*\(' --include="*.py" . | grep -v '^\./tests/' | grep -v '^#'; then FOUND=1; fi
          if grep -rEn '\bexec\s*\(' --include="*.py" . | grep -v '^\./tests/' | grep -v '^#'; then FOUND=1; fi
          if grep -rEn 'import pickle|import marshal' --include="*.py" . | grep -v '^\./tests/'; then FOUND=1; fi
          if [ "$FOUND" -eq 1 ]; then
            echo "âŒ Dangerous function usage detected!"
            exit 1
          fi
          echo "âœ… No dangerous functions found"

      - name: Security scan â€” HTTPS only
        run: |
          echo "ðŸ” Verifying all URLs use HTTPS..."
          if grep -rEn 'http://' --include="*.py" . | grep -v localhost | grep -v '127\.0\.0\.1' | grep -v '^\s*#' | grep -v '"""' | grep -v '^\./tests/'; then
            echo "âŒ Non-HTTPS URLs found!"
            exit 1
          fi
          echo "âœ… All external URLs use HTTPS"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 2: Test Matrix (3.10, 3.11, 3.12)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  test:
    name: Test (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    needs: lint
    permissions:
      contents: read

    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.11", "3.12"]

    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: ${{ matrix.python-version }}

      - name: Cache pip packages
        uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684 # v4.2.3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ matrix.python-version }}-${{ hashFiles('requirements.txt') }}
          restore-keys: ${{ runner.os }}-pip-${{ matrix.python-version }}-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest

      - name: Math engine tests (83 tests)
        run: pytest tests/test_math.py -v --tb=short

      - name: Unit tests (194 tests)
        run: pytest tests/test_units.py -v --tb=short

      - name: Code review tests â€” offline (T06â€“T40)
        run: pytest tests/test_codereview.py -v --tb=short -k "not network"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 3: Security & Privacy Gate (MUST PASS)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # This job runs ONLY the security and privacy tests as an explicit
  # gate.  If ANY security control is removed or broken, this job
  # fails and the merge is blocked.
  #
  # Controls enforced:
  #   T09  â€” No hardcoded secrets / sensitive data
  #   T23  â€” No vulnerabilities (eval/exec/http/pickle)
  #   T25  â€” LGPD compliance (data minimization, no PII)
  #   T27  â€” No tracking / telemetry
  #   T31  â€” Nonce-based CSP headers (CWE-79)
  #   T32  â€” EIP-55 address checksum validation (CWE-20)
  #   T33  â€” Error message sanitization (CWE-209)
  #   T34  â€” Client-side rate limiter (CWE-770)
  #   T35  â€” Temp file cleanup + 0o600 perms (CWE-377/459, LGPD)
  #   T36  â€” RPC URL masking in reports (CWE-200)
  #   T37  â€” Wallet address masking in output (CWE-532, LGPD)
  #   T38  â€” Tick bounds clamping (CWE-682)
  #   T39  â€” html.escape() stdlib for XSS (CWE-79)
  #   T40  â€” OWASP/CWE comprehensive audit
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  security-gate:
    name: "ðŸ”’ Security & Privacy Gate"
    runs-on: ubuntu-latest
    needs: lint
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Python 3.12
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: "3.12"

      - name: Cache pip packages
        uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684 # v4.2.3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-security-${{ hashFiles('requirements.txt') }}
          restore-keys: ${{ runner.os }}-pip-security-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest

      - name: "ðŸ›¡ï¸ Security controls (T31-T40) â€” CWE/OWASP enforcement"
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  SECURITY GATE â€” These controls can NEVER regress"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          pytest tests/test_codereview.py -v --tb=short \
            -k "t31 or t32 or t33 or t34 or t35 or t36 or t37 or t38 or t39 or t40"
          echo "âœ… All security controls enforced"

      - name: "ðŸ” Privacy controls (T09, T25, T27) â€” LGPD/GDPR enforcement"
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  PRIVACY GATE â€” Data protection can NEVER regress"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          pytest tests/test_codereview.py -v --tb=short \
            -k "t09 or t25 or t27"
          echo "âœ… All privacy controls enforced"

      - name: "ðŸ“‹ Vulnerability scan (T23) â€” eval/exec/secrets/http"
        run: |
          pytest tests/test_codereview.py -v --tb=short -k "t23"
          echo "âœ… Vulnerability scan passed"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 4: Documentation Drift Check
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Verifies that SECURITY.md, README.md, and COMPLIANCE.md stay
  # aligned with the actual codebase.  Catches stale test counts,
  # missing CWE references, and outdated badge labels.
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  doc-drift:
    name: "ðŸ“„ Doc Drift Check"
    runs-on: ubuntu-latest
    needs: lint
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Python 3.12
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest

      - name: Verify test count matches README
        run: |
          ACTUAL=$(pytest tests/ --collect-only -q 2>&1 | tail -1 | grep -oE '[0-9]+' | head -1)
          echo "Actual test count: $ACTUAL"
          if grep -q "$ACTUAL tests" README.md; then
            echo "âœ… README test count ($ACTUAL) matches"
          else
            echo "âŒ README test count does not match actual ($ACTUAL)"
            exit 1
          fi

      - name: Verify SECURITY.md references T31-T40
        run: |
          MISSING=0
          for T in T31 T32 T33 T34 T35 T36 T37 T38 T39 T40; do
            if ! grep -q "$T" SECURITY.md; then
              echo "âŒ SECURITY.md missing reference to $T"
              MISSING=1
            fi
          done
          if [ "$MISSING" -eq 1 ]; then exit 1; fi
          echo "âœ… SECURITY.md references all security controls"

      - name: Verify COMPLIANCE.md references T31-T40
        run: |
          MISSING=0
          for T in T31 T32 T33 T34 T35 T36 T37 T38 T39 T40; do
            if ! grep -q "$T" COMPLIANCE.md; then
              echo "âŒ COMPLIANCE.md missing reference to $T"
              MISSING=1
            fi
          done
          if [ "$MISSING" -eq 1 ]; then exit 1; fi
          echo "âœ… COMPLIANCE.md references all security controls"

      - name: Verify CWE IDs in codebase match SECURITY.md
        run: |
          echo "ðŸ” Cross-referencing CWE IDs..."
          MISSING=0
          for CWE in CWE-20 CWE-79 CWE-200 CWE-209 CWE-377 CWE-459 CWE-532 CWE-682 CWE-770; do
            if ! grep -q "$CWE" SECURITY.md; then
              echo "âŒ SECURITY.md missing $CWE"
              MISSING=1
            fi
            if ! grep -q "$CWE" tests/test_codereview.py; then
              echo "âŒ test_codereview.py missing $CWE"
              MISSING=1
            fi
          done
          if [ "$MISSING" -eq 1 ]; then exit 1; fi
          echo "âœ… All CWE IDs documented and tested"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 5: Codereview Report (artifact)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  codereview:
    name: Code Review Report
    runs-on: ubuntu-latest
    needs: [test, security-gate, doc-drift]
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Python 3.12
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest

      - name: Run full codereview suite
        run: |
          python tests/test_codereview.py --quick 2>&1 | tee codereview-report.txt
          echo "---"
          echo "Exit code: $?"

      - name: Upload codereview report
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: codereview-report
          path: codereview-report.txt
          retention-days: 30
